# Usage:
#   source set.env
# This script loads variables from .env (if present) and applies sane defaults.
# It can also bootstrap Node.js (via nvm) when missing.

# 1) Load .env into environment (export all assignments while sourcing)
if [ -f "./.env" ]; then
  set -a
  . ./.env
  set +a
fi

# 2) Defaults for this project
export SQLITE_PATH="${SQLITE_PATH:-./data/ontology_memori.db}"
export API_HOST="${API_HOST:-0.0.0.0}"
export API_PORT="${API_PORT:-8000}"

export LLM_PROVIDER="${LLM_PROVIDER:-openai}"
export OPENAI_MODEL="${OPENAI_MODEL:-gpt-4o-mini}"
export MEMORI_ENABLED="${MEMORI_ENABLED:-0}"

export LOCAL_BASE_URL="${LOCAL_BASE_URL:-http://localhost:11434/v1}"
export LOCAL_API_KEY="${LOCAL_API_KEY:-local}"
export LOCAL_MODEL="${LOCAL_MODEL:-qwen2.5:3b}"

export ENTITY_ID="${ENTITY_ID:-user-001}"
export PROCESS_ID="${PROCESS_ID:-ontology-agent}"

export MEMORI_EMBEDDINGS_MODEL="${MEMORI_EMBEDDINGS_MODEL:-all-MiniLM-L6-v2}"
export MAX_ONTOLOGY_FACTS="${MAX_ONTOLOGY_FACTS:-5}"
export MAX_RELATIONS="${MAX_RELATIONS:-3}"
export MAX_CONTEXT_CHARS="${MAX_CONTEXT_CHARS:-1200}"
export PROMPT_BUDGET_MODE="${PROMPT_BUDGET_MODE:-balanced}"
export PROMPT_TOKEN_WARN_THRESHOLD="${PROMPT_TOKEN_WARN_THRESHOLD:-220}"

export LOG_LEVEL="${LOG_LEVEL:-INFO}"
export ONTOLOGY_METHOD_DEFAULT="${ONTOLOGY_METHOD_DEFAULT:-method1}"

# 2-1) Method1 (Keyword Grounding) defaults
export M1_KEYWORD_MIN_TOKEN_LEN="${M1_KEYWORD_MIN_TOKEN_LEN:-2}"
export M1_KEYWORD_LIMIT="${M1_KEYWORD_LIMIT:-15}"

# 2-2) Method2 (Ontology Prompting / Policy) defaults
export M2_POLICY_STRICT_MODE="${M2_POLICY_STRICT_MODE:-1}"
export M2_POLICY_MAX_RULES="${M2_POLICY_MAX_RULES:-20}"

# 2-3) Method3/4 (GraphRAG / KG Reasoning) defaults
export GRAPH_BACKEND="${GRAPH_BACKEND:-sqlite}" # sqlite | neo4j
export GRAPH_TOP_K="${GRAPH_TOP_K:-20}"
export GRAPH_MAX_HOPS="${GRAPH_MAX_HOPS:-2}"
export NEO4J_URI="${NEO4J_URI:-bolt://localhost:7687}"
export NEO4J_USER="${NEO4J_USER:-neo4j}"
export NEO4J_PASSWORD="${NEO4J_PASSWORD:-neo4j}"
export NEO4J_DATABASE="${NEO4J_DATABASE:-neo4j}"

# 2-4) Method5 (Embedding retrieval) defaults
export EMBEDDING_PROVIDER="${EMBEDDING_PROVIDER:-sentence-transformers}"
export EMBEDDING_MODEL="${EMBEDDING_MODEL:-sentence-transformers/all-MiniLM-L6-v2}"
export VECTOR_DB_PROVIDER="${VECTOR_DB_PROVIDER:-chroma}" # chroma | faiss
export CHROMA_PERSIST_DIR="${CHROMA_PERSIST_DIR:-./data/chroma}"
export VECTOR_TOP_K="${VECTOR_TOP_K:-10}"
export HYBRID_ALPHA="${HYBRID_ALPHA:-0.7}" # dense/lexical blend ratio

# 2-5) Method6/7 (Neuro-symbolic / Verification) defaults
export RULE_ENGINE="${RULE_ENGINE:-z3}" # z3 | builtin
export RULE_STRICT_MODE="${RULE_STRICT_MODE:-1}"
export VERIFICATION_CANDIDATES="${VERIFICATION_CANDIDATES:-3}"
export CONFIDENCE_THRESHOLD="${CONFIDENCE_THRESHOLD:-0.65}"

# 2-6) Method8 (Ontology Enrichment) defaults
export ENRICHMENT_MAX_PROPOSALS="${ENRICHMENT_MAX_PROPOSALS:-5}"
export ENRICHMENT_ALLOW_NEW_RELATIONS="${ENRICHMENT_ALLOW_NEW_RELATIONS:-1}"
export ENRICHMENT_AUTO_APPLY="${ENRICHMENT_AUTO_APPLY:-0}"
export ONTOLOGY_EXPORT_PATH="${ONTOLOGY_EXPORT_PATH:-./data/ontologies/generated}"

# Optional: Hugging Face auth token for better model download limits/speed
# export HF_TOKEN="${HF_TOKEN:-}"

# 3) Node/NPM bootstrap via nvm (idempotent)
# Set AUTO_INSTALL_NODE=0 to skip automatic install/use.
export AUTO_INSTALL_NODE="${AUTO_INSTALL_NODE:-1}"
export NVM_DIR="${NVM_DIR:-$HOME/.nvm}"
mkdir -p "${NVM_DIR}"

if [ ! -s "/opt/homebrew/opt/nvm/nvm.sh" ] && command -v brew >/dev/null 2>&1; then
  echo "[set.env] nvm not found. Installing with Homebrew..."
  brew install nvm
fi

if [ -s "/opt/homebrew/opt/nvm/nvm.sh" ]; then
  . "/opt/homebrew/opt/nvm/nvm.sh"
fi
if [ -s "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm" ]; then
  . "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm"
fi

if [ "${AUTO_INSTALL_NODE}" = "1" ] && command -v nvm >/dev/null 2>&1; then
  if ! command -v node >/dev/null 2>&1; then
    echo "[set.env] Node.js not found. Installing LTS with nvm..."
    nvm install --lts
  fi
  nvm use --lts >/dev/null
fi

echo "[set.env] Loaded environment."
echo "[set.env] LLM_PROVIDER=${LLM_PROVIDER}, MEMORI_ENABLED=${MEMORI_ENABLED}, SQLITE_PATH=${SQLITE_PATH}, BUDGET_MODE=${PROMPT_BUDGET_MODE}, DEFAULT_METHOD=${ONTOLOGY_METHOD_DEFAULT}"
if command -v node >/dev/null 2>&1 && command -v npm >/dev/null 2>&1; then
  echo "[set.env] Node=$(node -v), NPM=$(npm -v)"
fi

if [ "${LLM_PROVIDER}" = "openai" ] && [ -z "${OPENAI_API_KEY:-}" ]; then
  echo "[set.env] Warning: OPENAI_API_KEY is empty."
fi
