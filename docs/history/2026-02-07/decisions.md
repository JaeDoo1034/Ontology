# 의사결정 기록

## 결정 1: 패키지/가상환경 관리로 `uv` 사용
- 상태: 채택
- 결정 일자: 2026-02-07
- 배경: 프로젝트 요구사항에서 `pip` 대신 `uv` 사용이 명시됨
- 결정 내용: `uv venv`, `uv sync`, `uv run` 중심으로 운영
- 근거: 의존성 잠금(`uv.lock`)과 실행 일관성을 유지하기 쉬움
- 영향 범위: 개발/실행 명령 전체, 온보딩 문서

## 결정 2: 온톨로지 포맷을 XML에서 YAML로 전환
- 상태: 채택
- 결정 일자: 2026-02-07
- 배경: 사용자 요청으로 온톨로지 정의를 YAML 형태로 관리하고자 함
- 결정 내용: `data/ontology.yaml`을 기준 데이터 소스로 사용
- 근거: 가독성/수정 편의성이 높고 Python에서 파싱이 단순함
- 영향 범위: ingest 로직, 샘플 데이터, 실행 명령/문서

## 결정 3: 온톨로지 DB와 메모리 저장소를 SQLite로 통합
- 상태: 채택
- 결정 일자: 2026-02-07
- 배경: MVP 단계에서 운영 복잡도를 최소화할 필요
- 결정 내용: 온톨로지 테이블과 Memori 테이블을 동일 SQLite 파일에 저장
- 근거: 환경 구성 단순화, 로컬 테스트 속도/재현성 확보
- 영향 범위: DB 경로 관리, schema/ingest/chat 실행 흐름

## 결정 4: 가격 질문에서 `price_krw` 우선 답변
- 상태: 채택
- 결정 일자: 2026-02-07
- 배경: "빠나 우유 가격"과 같은 질의에서 정답 우선 제공 필요
- 결정 내용: 가격 키워드 질의 시 `price_krw`를 우선 추출해 프롬프트 상단에 주입
- 근거: 온톨로지 사실 기반 응답 정확도 및 일관성 강화
- 영향 범위: 질의 전처리/검색 로직, 응답 품질 정책

## 결정 5: 실험 실행 파일을 `exp` 하위로 분리
- 상태: 채택
- 결정 일자: 2026-02-07
- 배경: 방법별 독립 실행성과 비교 실험 편의성 필요
- 결정 내용: `src/ontology_llm/exp/`에 method1..8 파일과 컨트롤러를 둠
- 근거: 메서드 단위 실험/디버깅/확장이 쉬움
- 영향 범위: 실험 실행 구조, 모듈 import 경로, 문서 예시

## 결정 6: `app.py`를 단일 메인 실행 엔트리로 유지
- 상태: 채택
- 결정 일자: 2026-02-07
- 배경: 실행 진입점이 분산되면 사용자 경험과 유지보수성이 떨어짐
- 결정 내용: `app.py`에 `exp` 서브커맨드를 추가해 실험 실행까지 메인에서 제어
- 근거: `init-db/ingest/chat/exp`를 하나의 CLI로 제공하면 운영 단순화 가능
- 영향 범위: CLI 인터페이스, 실행 문서, pyproject script 매핑

## 결정 7: method별 온톨로지 자동 적재(`--auto-ingest`) 지원
- 상태: 채택
- 결정 일자: 2026-02-07
- 배경: 8개 방법 실험에서 매번 수동 ingest 반복이 비효율적
- 결정 내용: method 선택 시 대응 YAML을 자동 적재하고 온톨로지 테이블을 초기화
- 근거: 실험 재현성 향상, 수동 작업 오류 방지
- 영향 범위: `src/ontology_llm/exp/controller.py`, 실험 실행 절차

## 결정 8: 바나나우유 질의에 function calling 적용
- 상태: 채택
- 결정 일자: 2026-02-07
- 배경: 도구 호출 시나리오를 MVP에 포함해 확장성 확인 필요
- 결정 내용: `바나나우유/빠나 우유` 질의 시 `get_today_date` 함수 호출 후 답변 생성
- 근거: LLM + tool use 결합 패턴 검증
- 영향 범위: `run_chat()` 메시지 플로우, 응답 생성 단계

## 결정 9: 히스토리 문서를 일자 폴더 구조로 운영
- 상태: 채택
- 결정 일자: 2026-02-07
- 배경: 세션이 늘어날수록 단일 파일 누적 방식은 탐색성이 낮음
- 결정 내용: `docs/history/YYYY-MM-DD/{session,change-log,decisions}.md` 구조 채택
- 근거: 날짜 단위 탐색/관리/보관이 용이
- 영향 범위: 히스토리 문서 위치, 인덱스 링크 규칙

## 결정 10: Memori 토큰 초과 대응을 애플리케이션 계층에서 우선 처리
- 상태: 채택
- 결정 일자: 2026-02-07
- 배경: 임베딩 모델 최대 길이 초과 경고가 반복되어 응답 안정성 저하 가능성 존재
- 결정 내용: `app.py`에서 prompt budget 측정/경고 로깅/컨텍스트 압축을 수행하고 환경변수로 제어
- 근거: memori 라이브러리 포크 없이 즉시 적용 가능하고 운영 중 조정이 쉬움
- 영향 범위: `run_chat()` 프롬프트 조립 단계, `.env` 설정, 테스트 시나리오

## 보류 항목 1: 가격 응답 템플릿 강제
- 상태: 보류
- 결정 일자: 2026-02-07
- 배경: 현재는 "우선 답변"만 구현, 출력 문장 포맷은 LLM 재량
- 결정 내용: `"<상품명> 가격은 <n>원입니다."` 형태 강제 여부는 추후 결정
- 근거: UX 선호도 확인 필요
- 영향 범위: 응답 후처리 계층, 테스트 기대값

## 보류 항목 2: function calling 출력 포맷 고정
- 상태: 보류
- 결정 일자: 2026-02-07
- 배경: 함수는 호출되지만 최종 문장 스타일은 모델 출력에 의존
- 결정 내용: 날짜 출력 문구(예: `오늘 날짜는 YYYY-MM-DD입니다.`) 후처리 강제 여부 추후 결정
- 근거: 사용자 선호/실험 목적에 따라 유연성 필요
- 영향 범위: 툴 결과 후처리, 회귀 테스트 기준

## 보류 항목 3: GraphRAG/RAPTOR 계열 중기 구조 전환
- 상태: 보류
- 결정 일자: 2026-02-07
- 배경: 현재는 길이 완화를 위해 애플리케이션 레벨 압축을 우선 적용함
- 결정 내용: 계층형 요약 검색/그래프 검색/재순위화(ColBERTv2 계열) 도입은 별도 단계에서 진행
- 근거: 구조 변경 범위가 크고 데이터/평가 체계 준비가 필요
- 영향 범위: 검색 아키텍처, 데이터 파이프라인, 평가 지표
